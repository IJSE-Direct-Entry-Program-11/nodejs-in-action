import * as fs from 'node:fs/promises';
import path from "node:path";

const targetDirPath = path.resolve(process.cwd(), "target");
const fileList = await fs.readdir(targetDirPath);
for (const file of fileList) {
    await encryptFile(file);
}

async function encryptFile(fileName:string){
    const encryptedFilePath = path.resolve(targetDirPath, fileName + ".encrypted");
    const encryptedFile = await fs.open(encryptedFilePath, "a");
    const originalFile = await fs.open(path.resolve(targetDirPath, fileName));

    const os = encryptedFile.createWriteStream();
    const is = originalFile.createReadStream();
    for await (const bytes of is){
        for(let i = 0; i < bytes.length; i ++){
            bytes[i] = ~bytes[i];
        }
        os.write(bytes);
    }
    os.end();
    await fs.rm(path.resolve(targetDirPath, fileName));
}
